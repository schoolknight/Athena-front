<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>


    <script src="{{url_for('static', filename='echarts.min.js')}}"></script>



  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="../static/mdb/bootstrap.min.css">
  <!-- Material Design Bootstrap -->
  <link rel="stylesheet" href="../static/mdb/mdb.min.css">
  <!-- Your custom styles (optional) -->
  <link rel="stylesheet" href="../static/css/athena.css">
  <!-- MDBootstrap Datatables  -->
  <link href="../static/mdb/addons/datatables2.min.css" rel="stylesheet">
  <!-- DataTables Select CSS -->
  <link href="../static/mdb/addons/datatables-select2.min.css" rel="stylesheet">

  <link href="{{url_for('static', filename='css/dashboard.css')}}" rel="stylesheet">
  <link href="{{url_for('static', filename='toastr/jquery.toast.min.css')}}" rel="stylesheet">

  <!-- jQuery -->
  <script type="text/javascript" src="../static/jquery.min.js"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="../static/mdb/popper.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" src="../static/mdb/bootstrap.min.js"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="../static/mdb/mdb.min.js"></script>

  <!-- MDBootstrap Datatables  -->
  <script type="text/javascript" src="../static/mdb/addons/datatables2.min.js"></script>
  <!-- DataTables Select JS -->
  <script src="../static/mdb/addons/datatables-select2.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="{{url_for('static', filename='toastr/jquery.toast.min.js')}}"></script>

  </head>
  <body class="fixed-sn light-blue-skin">
    <header>

      <!-- Sidebar navigation -->
      <div id="slide-out" class="side-nav side-nav-light fixed">
        <ul class="custom-scrollbar">
          <!-- Athena Logo -->
          <li>
            <div class="text-center logo-wrapper waves-light">
              <a href="#" class="pl-0"><img src="../static/img/THU.png" class="img-fluid flex-center" style="height: 95px"></a>
            </div>
          </li>

          <!--/. Athena Logo -->
          <!--Social-->
          <li>
            <ul class="social">
              <li><a href="#" class="icons-sm fb-ic"><i class="fab fa-facebook-f"> </i></a></li>
              <li><a href="#" class="icons-sm pin-ic"><i class="fab fa-pinterest"> </i></a></li>
              <li><a href="#" class="icons-sm gplus-ic"><i class="fab fa-google-plus-g"> </i></a></li>
              <li><a href="#" class="icons-sm tw-ic"><i class="fab fa-twitter"> </i></a></li>
            </ul>
          </li>
          <!--/Social-->
          <!--Search Form-->
          <li>
            <form class="search-form" role="search">
              <div class="form-group md-form mt-0 pt-1 waves-light">
                <input type="text" class="form-control" placeholder="Search">
              </div>
            </form>
          </li>
          <!--/.Search Form-->

          <!-- Side navigation links -->
          <li>
            <ul class="collapsible collapsible-accordion">
              <li><a class="collapsible-header waves-effect arrow-r"><i class="fab fa-servicestack"></i>Service<i class="fas fa-angle-down rotate-icon"></i></a>
                <div class="collapsible-body">
                  <ul class="list-unstyled">
                    <li><a href="athena-service" class="waves-effect">Issue service</a>
                    </li>
                    <li><a href="athena-order" class="waves-effect">My orders</a>
                    </li>
                  </ul>
                </div>
              </li>
              <li><a class="collapsible-header waves-effect arrow-r"><i class="fas fa-eye"></i> My account<i class="fas fa-angle-down rotate-icon"></i></a>
                <div class="collapsible-body">
                  <ul class="list-unstyled">
                    <li><a href="athena-statistics" class="waves-effect">Profile</a>
                    </li>
                    <li><a href="athena-balance" class="waves-effect">Balance</a>
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
            <!--/. Side navigation links -->
          </li>
          <!--/ Side navigation links -->

        </ul>
        <div class="sidenav-bg purple lighten-3"></div>
      </div>
      <!--/. Sidebar navigation -->

      <!-- Navbar -->
      <nav class="navbar fixed-top navbar-expand-lg scrolling-navbar double-nav">

        <!-- SideNav slide-out button -->
        <div class="float-left">
          <a href="#" data-activates="slide-out" class="button-collapse"><i class="fas fa-bars"></i></a>
        </div>

        <!-- Breadcrumb -->
        <div class="breadcrumb-dn mr-auto">
          <p>Service Panel</p>
        </div>

        <div class="d-flex change-mode">

          <!-- Navbar links -->
          <ul class="nav navbar-nav nav-flex-icons ml-auto">

            <!-- Dropdown -->
            <li class="nav-item dropdown notifications-nav">
              <a class="nav-link dropdown-toggle waves-effect" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="badge green">3</span> <i class="fas fa-bell"></i>
                <span class="d-none d-md-inline-block">Notifications</span>
              </a>
              <div class="dropdown-menu dropdown-primary" aria-labelledby="navbarDropdownMenuLink">
                <a class="dropdown-item" href="#">
                  <i class="fab fa-servicestack" aria-hidden="true"></i>
                  <span>Recent service completed</span>
                  <span class="float-right"><i class="far fa-clock" aria-hidden="true"></i> 5 min</span>
                </a>
                <a class="dropdown-item" href="#">
                  <i class="fab fa-servicestack" aria-hidden="true"></i>
                  <span>New service issued</span>
                  <span class="float-right"><i class="far fa-clock" aria-hidden="true"></i> 2 min</span>
                </a>
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link waves-effect"><i class="far fa-comments"></i> <span class="clearfix d-none d-sm-inline-block">Support</span></a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle waves-effect" href="#" id="userDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-user"></i> <span class="clearfix d-none d-sm-inline-block">Profile</span>
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                <a class="dropdown-item" href="#">Log Out</a>
                <a class="dropdown-item" href="#">My account</a>
              </div>
            </li>

          </ul>
          <!-- Navbar links -->

        </div>

      </nav>
      <!-- Navbar -->

    </header>

    <main>

      <div class="contianer-fluid">

        <div class="mt-lg-5 mb-5">

          <h4 class="text-left font-weight-bold dark-grey-text">Athena System Overview</h4>
          <hr>

        </div>

        <!-- Section: Data -->
        <section class="mt-md-4 pt-md-2 ml-md-5 pl-4 mb-2 pb-1">

          <div class="card border-secondary mb-3">

            <div class="card-header ">System States</div>
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <div class="card">
                      <!-- Card image -->
                      <img class="card-img-top mx-auto d-block status-card" src="{{url_for('static', filename='img/system_health.jpg')}}" alt="Card image cap" style="width: 200px;">
                      <!-- Card content -->
                      <div class="card-body">
                        <!-- Title -->
                        <h4 class="card-title"><a>System Health:60%</a></h4>

                      </div>

                    </div>
                  </div>
                  <div class="col">
                    <div class="card">
                      <!-- Card image -->
                      <img class="card-img-top  mx-auto d-block status-card" src="{{url_for('static', filename='img/blockchain.svg')}}" alt="Card image cap">
                      <!-- Card content -->
                      <div class="card-body">
                        <!-- Title -->
                        <h4 class="card-title"><a>Node Number:5</a></h4>
                        <!-- Text -->

                      </div>

                    </div>
                  </div>
                  <div class="col">
                    <div class="card">

                      <!-- Card image -->
                      <img class="card-img-top  mx-auto d-block status-card" src="{{url_for('static', filename='img/smart_contract.png')}}" alt="Card image cap">

                      <!-- Card content -->
                      <div class="card-body">

                        <!-- Title -->
                        <h4 class="card-title"><a id='contract_number'>Active Contracts: 0</a></h4>
                        <!-- Text -->

                      </div>

                    </div>
                  </div>
                </div>


              </div>
          </div>
        </section>
        <!--/ Section: Data -->

        <!-- Section: Function -->
        <section class="mt-md-4 pt-md-2 ml-md-5 pl-4 mb-2 pb-1">
          <div class="card border-secondary mb-3">

            <div class="card-header">Active Smart Contracts</div>

            <!-- Section: Filter -->

              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <div class="btn-group-vertical" role="group" id='contract_button'>
                    </div>
                  </div>
                  <div class="col-8">
                    <div class="card">
                      <div class="card-body" id='contract_detail'>


                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex justify-content-center">
                <div class=" chart-area" id="main_chart"></div>
              </div>
            </section>




          </div>
        </section>
        <!--/ Section: Function -->

        <!-- Section: Security -->


        <!-- Service confirm -->


      </div>

    </main>




    <script type="text/javascript">
      var myChart = echarts.init(document.getElementById('main_chart'));
      var deal_list = [];
      var currentButton = 0;
      function refreshDeal(ifToast){
        $.getJSON("/get_deals", function(result){
          var refreshFlag = 0;
          for(var i in result){
            var item = result[i];
            var tmpFlag = 0;
            for (var j in deal_list){
              if (item['_id'] == deal_list[j]['_id']){
                tmpFlag = 1;
                break;
              }
            }
            if (tmpFlag == 0){
              refreshFlag = 1;
              break;
            }
          }
          deal_list = result;
          if (refreshFlag > 0){
            if (ifToast > 0){
              $.toast({
                text : "New Contracts",
                position : {
                  top:70,
                  right:10
                }
              });
            }
            updatePage();
          }

        });
      }
      function setChart(item){
        var option = {
          tooltip: {},
          animationDurationUpdate: 1500,
          animationEasingUpdate: 'quinticInOut',
          series: [
            {
              type: 'graph',
              layout: 'none',
              symbol:"roundRect",
              symbolSize: 150,
              label: {
                show: true,
                fontSize:30
              },
              edgeSymbol: ['circle', 'arrow'],
              edgeSymbolSize: [4, 10],
              edgeLabel: {
                fontSize: 50
              },
              data: [{
                name: 'hospital',
                value:10,
                x: 100,
                y: 250,
                itemStyle:{
                    color:'#6699CC'
                },
                label:{
                  formatter: "{b}\n{c}%"
                },
                tooltip:{
                    formatter:'{b} process {c}%'
                }

              },{
                name: 'patient',
                value: 10,
                x: 300,
                y: 250,
                itemStyle:{
                    color:'#006699'
                },
                label:{
                  formatter: "{b}\n{c}%"
                },
                tooltip:{
                    formatter:'{b} process {c}%'
                }
              }, {
                name: 'research',
                x: 200,
                y: 150,
                itemStyle:{
                    color:'#000000'
                }
              }],
              // links: [],
              links: [{
                source: 0,
                target: 1,
                symbolSize: [5, 20],
                lineStyle: {
                    width: 5,
                    curveness: -0.2
                }
              },{
                source: 1,
                target: 2,
                symbolSize: [5, 20],
                lineStyle: {
                    width: 5,
                    curveness: -0.2
                }
              },{
                source: 2,
                target: 0,
                symbolSize: [5, 20],
                lineStyle: {
                    width: 5,
                    curveness: -0.2
                }
              },
            ],
            lineStyle: {
                opacity: 0.9,
                width: 2,
                curveness: 0
            }
          }]
        };
        var totalHospital = 0;
        for (var i in item.hospital){
          totalHospital += item.hospital[i];
        }
        option.series[0].data[0].value = totalHospital * 100 / item.hospital.length;
        console.log(totalHospital * 100 / item.hospital.length);
        var totalPatient = 0;
        for (var i in item.patient){
          totalPatient += item.patient[i];
        }
        option.series[0].data[1].value = totalPatient * 100 / item.patient.length;
        console.log(totalPatient * 100 / item.patient.length);
        myChart.setOption(option);
      }

      function updatePage(){
        $('#contract_number').text('Active Contracts: ' + deal_list.length);
        var buttonStr = "";
        for (var i in deal_list){
          var item = deal_list[i];
          if (i == currentButton){
            buttonStr += '<button type="button" class="btn btn-success" onclick="showDeal(' + i + ')">' + item['_id'] + '</button>\n';
            var detailStr = '<h5 class="card-title">Contract : ' + item['_id'] + '</h5>\n';
            detailStr += '<p class="card-text">Data Number:' + item['dataNum'] +  '</p>';
            detailStr += '<p class="card-text">Created At:' + item['createdAt'] +  '</p>';
            $('#contract_detail').html(detailStr);
            setChart(item);
          }else{
            buttonStr += '<button type="button" class="btn" onclick="showDeal(' + i + ')">' + item['_id'] + '</button>\n';
          }
        }
        $('#contract_button').html(buttonStr);
      }
      function showDeal(tarId){
        if (tarId != currentButton){
          var buttonList = $('#contract_button button');
          buttonList.eq(currentButton).removeClass('btn-success');
          buttonList.eq(tarId).addClass('btn-success');
          var detailStr = '<h5 class="card-title">Contract : ' + deal_list[tarId]['_id'] + '</h5>\n';
          detailStr += '<p class="card-text">Data Number:' + deal_list[tarId]['dataNum'] +  '</p>';
          detailStr += '<p class="card-text">Created At:' + deal_list[tarId]['createdAt'] +  '</p>';
          $('#contract_detail').html(detailStr);
          setChart(deal_list[tarId]);
          currentButton = tarId;
        }
      }
      refreshDeal(0);

      setInterval(() => {
        refreshDeal(1);
      }, 10000);

      // 基于准备好的dom，初始化echarts实例
      //toastr.info('test');





      // 指定图表的配置项和数据

      // 使用刚指定的配置项和数据显示图表。

    </script>


  </body>
</html>
